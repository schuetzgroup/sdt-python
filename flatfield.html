

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Flat field correction &mdash; sdt-python 14.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Fluorescent feature localization" href="loc.html" />
    <link rel="prev" title="Image filtering and processing" href="image.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> sdt-python
          

          
          </a>

          
            
            
              <div class="version">
                14.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="roi.html">Regions of interest (ROIs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="chromatic.html">Overlay color channels</a></li>
<li class="toctree-l1"><a class="reference internal" href="multicolor.html">Multi-color data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="motion.html">Diffusion analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="brightness.html">Brightness analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="io.html">Data input/output</a></li>
<li class="toctree-l1"><a class="reference internal" href="changepoint.html">Changepoint detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="spatial.html">Analyze spatial aspects of data</a></li>
<li class="toctree-l1"><a class="reference internal" href="fret.html">Single molecule FRET analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="image.html">Image filtering and processing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Flat field correction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#programming-reference">Programming reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="loc.html">Fluorescent feature localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="nbui.html">GUIs for the Jupyter notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="sim.html">Simulation of microscopy-related data</a></li>
<li class="toctree-l1"><a class="reference internal" href="funcs.html">Special functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot.html">Plotting utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="exp_fit.html">Fit of a sum of exponential functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="gaussian_fit.html">Fitting of 1D and 2D Gaussian functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="helper.html">Helpers for writing new code</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">Change log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">sdt-python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Flat field correction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <span class="target" id="module-sdt.flatfield"></span><div class="section" id="flat-field-correction">
<h1>Flat field correction<a class="headerlink" href="#flat-field-correction" title="Permalink to this headline">¶</a></h1>
<p>The intensity cross section of a laser beam is usually not flat, but of
Gaussian shape or worse. That means that fluorophores closer to the edges of
the image will appear dimmer simply because they do not receive so much
exciting laser light.</p>
<p>A camera’s pixels may differ in efficiency so that even a homogeneously
illuminated sample will not look homogeneous.</p>
<p>Errors as these can corrected for to some extent by <em>flat field correction</em>.
The error is determined by recording a supposedly homogeneous (flat) sample
(e.g. a homogeneously fluorescent surface) and can later be removed from
other/real experimental data.</p>
<p class="rubric">Examples</p>
<p>First, load images that show the error, e.g. images of a surface with
homogenous fluorescence label.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">baseline</span> <span class="o">=</span> <span class="mf">200.</span>  <span class="c1"># camera baseline</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Load homogenous sample image sequences</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img1</span> <span class="o">=</span> <span class="n">pims</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;flat1.tif&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img2</span> <span class="o">=</span> <span class="n">pims</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;flat2.tif&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>These can now be used to create the <a class="reference internal" href="#sdt.flatfield.Corrector" title="sdt.flatfield.Corrector"><code class="xref py py-class docutils literal notranslate"><span class="pre">Corrector</span></code></a> object:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">corr</span> <span class="o">=</span> <span class="n">Corrector</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="n">baseline</span><span class="p">)</span>
</pre></div>
</div>
<p>With help of <code class="docutils literal notranslate"><span class="pre">corr</span></code>, other images or even whole image sequences (when using
<code class="xref py py-mod docutils literal notranslate"><span class="pre">pims</span></code> to load them) can now be corrected.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">img3</span> <span class="o">=</span> <span class="n">pims</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;experiment_data.tif&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img3_flat</span> <span class="o">=</span> <span class="n">corr</span><span class="p">(</span><span class="n">img3</span><span class="p">)</span>
</pre></div>
</div>
<p>The brightness values of single molecule data may be corrected as well:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sm_data</span> <span class="o">=</span> <span class="n">sdt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;data.h5&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sm_data_flat</span> <span class="o">=</span> <span class="n">corr</span><span class="p">(</span><span class="n">sm_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="programming-reference">
<h2>Programming reference<a class="headerlink" href="#programming-reference" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="sdt.flatfield.Corrector">
<em class="property">class </em><code class="sig-prename descclassname">sdt.flatfield.</code><code class="sig-name descname">Corrector</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">data</span></em>, <em class="sig-param"><span class="n">bg</span><span class="o">=</span><span class="default_value">0.0</span></em>, <em class="sig-param"><span class="n">gaussian_fit</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">shape</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">density_weight</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">smooth_sigma</span><span class="o">=</span><span class="default_value">0.0</span></em>, <em class="sig-param"><span class="n">columns</span><span class="o">=</span><span class="default_value">{}</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sdt/flatfield.html#Corrector"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#sdt.flatfield.Corrector" title="Permalink to this definition">¶</a></dt>
<dd><p>Flat field correction</p>
<p>This works by multiplying features’ integrated intensities (“mass”) by
a position-dependent correction factor. The factor can be calculated from
a series of images of a fluorescent surface or from single molecule data.</p>
<p>The factor is calculated in case of a fluorescent surface by</p>
<ul class="simple">
<li><p>Taking the averages of the pixel intensities of the images</p></li>
<li><p>If requested, doing a 2D Gaussian fit</p></li>
<li><p>Normalizing, so that the maximum of the Gaussian or of the average image
(if on Gaussian fit was performed) equals 1.0</p></li>
</ul>
<p>or in the case of single molecule data by fitting a 2D Gaussian to their
“mass” values. Single molecule density fluctuations are take into account
by weighing data points inversely to their density in the fit.</p>
<p>The “signal” and “mass” of a feature at position (x, y) are then divided by
the value of the Gaussian at the positon (x, y) (or the pixel intensity of
the image) to yield a corrected value. Also, image data can be corrected
analogously in a pixel-by-pixel fashion.</p>
<p><strong>Images (both for deterimnation of the correction and those to be
corrected) need to have their background subtracted for this to work
properly.</strong> This can be done by telling the <cite>Corrector</cite> object what the
background is (or of course, before passing the data to the <cite>Corrector</cite>.)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>*data</strong> (<em>iterables of image data or pandas.DataFrames</em>) – Collections of images fluorescent surfaces or single molecule
data to use for determining the correction function.</p></li>
<li><p><strong>bg</strong> (<em>scalar or array-like, optional</em>) – Background that is subtracted from each image. This may be a
scalar or an array of the same size as the images in <cite>data</cite>. It
is not used on single molecule data. Also sets the
:py:attr`bg` attribute. Defaults to 0.</p></li>
<li><p><strong>gaussian_fit</strong> (<em>bool, optional</em>) – Whether to fit a Gaussian to the averaged image. This is ignored
if <cite>data</cite> is single molecule data. Default: True</p></li>
<li><p><strong>shape</strong> (<em>tuple of int</em>) – If <cite>data</cite> is single molecule data and <cite>shape</cite> is not None, create
<a class="reference internal" href="#sdt.flatfield.Corrector.avg_img" title="sdt.flatfield.Corrector.avg_img"><code class="xref py py-attr docutils literal notranslate"><span class="pre">avg_img</span></code></a> and <a class="reference internal" href="#sdt.flatfield.Corrector.corr_img" title="sdt.flatfield.Corrector.corr_img"><code class="xref py py-attr docutils literal notranslate"><span class="pre">corr_img</span></code></a> from the fit using the
given shape. Defaults to None.</p></li>
<li><p><strong>density_weight</strong> (<em>bool, optional</em>) – If <cite>data</cite> is single molecule data, weigh data points inversely to
their density for fitting so that areas with higher densities don’t
have a higher impact on the result. Defaults to False.</p></li>
<li><p><strong>smooth_sigma</strong> (<em>float, optional</em>) – If &gt; 0, smooth the image used for flatfield correction. Only
applicable if <code class="docutils literal notranslate"><span class="pre">gaussian_fit=False</span></code>. Defaults to 0.</p></li>
</ul>
</dd>
<dt class="field-even">Other Parameters</dt>
<dd class="field-even"><p><strong>columns</strong> (<em>dict, optional</em>) – Override default column names as defined in
<code class="xref py py-attr docutils literal notranslate"><span class="pre">config.columns</span></code>. Only applicable of <cite>data</cite> are single
molecule DataFrames. The relevant names are <cite>coords</cite> and <cite>mass</cite>.
That means, if the DataFrames have coordinate columns “x” and “z”
and a mass column “alt_mass”, set
<code class="docutils literal notranslate"><span class="pre">columns={&quot;coords&quot;:</span> <span class="pre">[&quot;x&quot;,</span> <span class="pre">&quot;z&quot;],</span> <span class="pre">&quot;mass&quot;:</span> <span class="pre">&quot;alt_mass&quot;}</span></code>.</p>
</dd>
</dl>
<dl class="py attribute">
<dt id="sdt.flatfield.Corrector.bg">
<code class="sig-name descname">bg</code><a class="headerlink" href="#sdt.flatfield.Corrector.bg" title="Permalink to this definition">¶</a></dt>
<dd><p>Background to be subtracted from image data.</p>
</dd></dl>

<dl class="py attribute">
<dt id="sdt.flatfield.Corrector.avg_img">
<code class="sig-name descname">avg_img</code><a class="headerlink" href="#sdt.flatfield.Corrector.avg_img" title="Permalink to this definition">¶</a></dt>
<dd><p>Pixel-wise average image from <cite>data</cite> argument to
<code class="xref py py-meth docutils literal notranslate"><span class="pre">__init__()</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt id="sdt.flatfield.Corrector.fit_result">
<code class="sig-name descname">fit_result</code><a class="headerlink" href="#sdt.flatfield.Corrector.fit_result" title="Permalink to this definition">¶</a></dt>
<dd><p>If a Gaussian fit was done, this holds the result. Otherwise, it is
<cite>None</cite>.</p>
</dd></dl>

<dl class="py attribute">
<dt id="sdt.flatfield.Corrector.corr_img">
<code class="sig-name descname">corr_img</code><a class="headerlink" href="#sdt.flatfield.Corrector.corr_img" title="Permalink to this definition">¶</a></dt>
<dd><p>Pixel data used for correction of images. Any image to be corrected
is divided pixel-wise by <cite>corr_img</cite>.</p>
</dd></dl>

<dl class="py method">
<dt id="sdt.flatfield.Corrector.__call__">
<code class="sig-name descname">__call__</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">data</span></em>, <em class="sig-param"><span class="n">inplace</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">bg</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">columns</span><span class="o">=</span><span class="default_value">{}</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sdt/flatfield.html#Corrector.__call__"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#sdt.flatfield.Corrector.__call__" title="Permalink to this definition">¶</a></dt>
<dd><p>Do brightness correction on <cite>features</cite> intensities</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data</strong> (<em>pandas.DataFrame or pims.FramesSequence or array-like</em>) – data to be processed. If a pandas.Dataframe, correct the “mass”
column according to the particle position in the laser beam.
Otherwise, <cite>slicerator.pipeline</cite> is used to correct raw image data.</p></li>
<li><p><strong>inplace</strong> (<em>bool, optional</em>) – Only has an effect if <cite>data</cite> is a DataFrame. If True, the
feature intensities will be corrected in place. Defaults to False.</p></li>
<li><p><strong>bg</strong> (<em>scalar or array-like, optional</em>) – Background to be subtracted from image data. If <cite>None</cite>, use the
<a class="reference internal" href="#sdt.flatfield.Corrector.bg" title="sdt.flatfield.Corrector.bg"><code class="xref py py-attr docutils literal notranslate"><span class="pre">bg</span></code></a> attribute. Ignored for single molecule data.
Defaults to <cite>None</cite>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>If <cite>data</cite> is a DataFrame and <cite>inplace</cite> is False, return the
corrected frame. If <cite>data</cite> is raw image data, return corrected
images</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>pandas.DataFrame or pims.SliceableIterable or numpy.array</p>
</dd>
<dt class="field-even">Other Parameters</dt>
<dd class="field-even"><p><strong>columns</strong> (<em>dict, optional</em>) – Override default column names as defined in
<code class="xref py py-attr docutils literal notranslate"><span class="pre">config.columns</span></code>. Only applicable of <cite>data</cite> are single
molecule DataFrames. The relevant names are <cite>coords</cite>, <cite>signal</cite>, and
<cite>mass</cite>. That means, if the DataFrames have coordinate columns “x”
and “z” and a mass column “alt_mass”, set
<code class="docutils literal notranslate"><span class="pre">columns={&quot;coords&quot;:</span> <span class="pre">[&quot;x&quot;,</span> <span class="pre">&quot;z&quot;],</span> <span class="pre">&quot;mass&quot;:</span> <span class="pre">&quot;alt_mass&quot;}</span></code>.
It is also possible to give a list of columns to correct by adding
the “corr” key, e.g. <code class="docutils literal notranslate"><span class="pre">columns={&quot;corr&quot;:</span> <span class="pre">[&quot;mass&quot;,</span> <span class="pre">&quot;alt_mass&quot;]}</span></code>.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="sdt.flatfield.Corrector.get_factors">
<code class="sig-name descname">get_factors</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">x</span></em>, <em class="sig-param"><span class="n">y</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sdt/flatfield.html#Corrector.get_factors"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#sdt.flatfield.Corrector.get_factors" title="Permalink to this definition">¶</a></dt>
<dd><p>Get correction factors at positions x, y</p>
<p>Depending on whether gaussian_fit was set to True or False in the
constructor, the correction factors for each feature that described by
an x and a y coordinate is calculated either from the Gaussian fit
or the average image itself.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>x, y</strong> (<em>list of float</em>) – x and y coordinates of features</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A list of correction factors corresponding to the features</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>numpy.ndarray</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="sdt.flatfield.Corrector.save">
<code class="sig-name descname">save</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">file</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sdt/flatfield.html#Corrector.save"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#sdt.flatfield.Corrector.save" title="Permalink to this definition">¶</a></dt>
<dd><p>Save instance to disk</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>file</strong> (<em>str or file-like object</em>) – Where to save. If <cite>str</cite>, the extension “.npz” will be appended if
it is not present.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="sdt.flatfield.Corrector.load">
<em class="property">classmethod </em><code class="sig-name descname">load</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">file</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/sdt/flatfield.html#Corrector.load"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#sdt.flatfield.Corrector.load" title="Permalink to this definition">¶</a></dt>
<dd><p>Load from disk</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>file</strong> (<em>str or file-like</em>) – Where to load from</p></li>
<li><p><strong>old_format</strong> (<em>bool, optional</em>)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Loaded instance</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference internal" href="#sdt.flatfield.Corrector" title="sdt.flatfield.Corrector">sdt.flatfield.Corrector</a></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="loc.html" class="btn btn-neutral float-right" title="Fluorescent feature localization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="image.html" class="btn btn-neutral float-left" title="Image filtering and processing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015—2018, Lukas Schrangl

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>